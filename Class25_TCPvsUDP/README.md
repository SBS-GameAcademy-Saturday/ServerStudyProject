# Class 25. TCP vs UDP

## [1] TCP (Transmission Control Protocol)

### 정의
- 연결 지향 프로토콜 (Connection-Oriented)
- 신뢰성 있는 데이터 전송 보장
- 스트림 기반 (Stream-based)

### 특징

**연결 수립 (3-Way Handshake)**
```
Client                    Server
   │                         │
   ├─── SYN ────────────────▶│  1. 연결 요청
   │                         │
   │◀─── SYN-ACK ────────────┤  2. 연결 수락
   │                         │
   ├─── ACK ────────────────▶│  3. 연결 확인
   │                         │
   ├═══ 데이터 전송 ═══════╪═
```

**연결 종료 (4-Way Handshake)**
```
Client                    Server
   │                         │
   ├─── FIN ────────────────▶│  1. 종료 요청
   │                         │
   │◀─── ACK ─────────────────┤  2. 종료 확인
   │                         │
   │◀─── FIN ─────────────────┤  3. 종료 요청
   │                         │
   ├─── ACK ────────────────▶│  4. 종료 확인
   │                         │
```

### 신뢰성 보장 메커니즘

**1) 순서 보장 (Sequence Number)**
```
송신:
Packet 1: [Seq=100] "Hello"
Packet 2: [Seq=105] "World"

도착 순서:
Packet 2 도착 → 버퍼에 대기
Packet 1 도착 → 순서대로 조립

결과: "HelloWorld" (순서 보장)
```

**2) 재전송 (Retransmission)**
```
송신: Packet [Seq=100] "Data"
      ↓
      ✗ (패킷 손실)
      
타임아웃 발생
      ↓
재전송: Packet [Seq=100] "Data"
      ↓
      ✓ (정상 수신)
```

**3) 흐름 제어 (Flow Control)**
```
수신자 버퍼 상태:
┌────────────────────┐
│ Available: 1000    │
└────────────────────┘

송신자:
"남은 공간 1000 bytes구나"
→ 최대 1000 bytes만 전송

수신자 버퍼 가득 참:
┌────────────────────┐
│ Available: 0       │
└────────────────────┘

송신자: 대기 (전송 중단)
```

**4) 혼잡 제어 (Congestion Control)**
```
네트워크 상태 감지:
패킷 손실 감지 → 네트워크 혼잡
                 ↓
            전송 속도 감소

정상 전송 → 네트워크 양호
            ↓
       전송 속도 증가
```

### TCP 헤더 구조
```
┌──────────────────────────────────────┐
│ Source Port (2 bytes)                │
├──────────────────────────────────────┤
│ Destination Port (2 bytes)           │
├──────────────────────────────────────┤
│ Sequence Number (4 bytes)            │ ← 순서 보장
├──────────────────────────────────────┤
│ Acknowledgment Number (4 bytes)      │ ← 확인 응답
├──────────────────────────────────────┤
│ Header Length, Flags (2 bytes)       │
│ - SYN, ACK, FIN, RST...              │
├──────────────────────────────────────┤
│ Window Size (2 bytes)                │ ← 흐름 제어
├──────────────────────────────────────┤
│ Checksum (2 bytes)                   │ ← 오류 검출
├──────────────────────────────────────┤
│ Urgent Pointer (2 bytes)             │
├──────────────────────────────────────┤
│ Options (가변)                       │
└──────────────────────────────────────┘

최소 크기: 20 bytes
```

### 장점
- ✅ 신뢰성 보장 (데이터 손실 없음)
- ✅ 순서 보장
- ✅ 흐름 제어
- ✅ 혼잡 제어
- ✅ 연결 상태 관리

### 단점
- ❌ 느림 (오버헤드 큼)
- ❌ 연결 수립/종료 시간
- ❌ 1:1 통신만 가능
- ❌ 헤더 크기 큼 (20+ bytes)

### 사용 예시
```
웹 브라우징 (HTTP/HTTPS):
- 데이터 정확성 중요
- 순서 보장 필요

이메일 (SMTP, POP3):
- 메일 내용 손실 안 됨
- 완전성 보장

파일 전송 (FTP):
- 파일 무결성
- 순서대로 조립

게임:
- MMORPG 로그인/채팅
- 거래 시스템
- 중요 게임 로직
```

---

## [2] UDP (User Datagram Protocol)

### 정의
- 비연결 프로토콜 (Connectionless)
- 신뢰성 없는 데이터 전송
- 데이터그램 기반 (Datagram-based)

### 특징

**비연결 통신**
```
Client                    Server
   │                         │
   ├─── 데이터그램 1 ────────▶│  (연결 수립 없음)
   │                         │
   ├─── 데이터그램 2 ────────▶│
   │     ✗ (손실)            │
   │                         │
   ├─── 데이터그램 3 ────────▶│
   │                         │
   
결과: 데이터그램 1, 3만 도착 (2는 손실)
```

### UDP 헤더 구조
```
┌──────────────────────────────────────┐
│ Source Port (2 bytes)                │
├──────────────────────────────────────┤
│ Destination Port (2 bytes)           │
├──────────────────────────────────────┤
│ Length (2 bytes)                     │
├──────────────────────────────────────┤
│ Checksum (2 bytes)                   │
└──────────────────────────────────────┘

고정 크기: 8 bytes (TCP의 1/3)
```

### 특성

**1) 순서 보장 안 됨**
```
송신:
Packet 1: "Hello"
Packet 2: "World"

수신 (순서 바뀔 수 있음):
Packet 2: "World"
Packet 1: "Hello"
```

**2) 손실 가능**
```
송신: 100개 패킷
수신: 95개 패킷 (5개 손실)

재전송 없음!
```

**3) 중복 가능**
```
송신: Packet 1
네트워크에서 복제됨
수신: Packet 1, Packet 1 (중복)
```

### 장점
- ✅ 빠름 (오버헤드 작음)
- ✅ 실시간 전송
- ✅ 브로드캐스트/멀티캐스트 가능
- ✅ 헤더 작음 (8 bytes)
- ✅ 연결 수립 시간 없음

### 단점
- ❌ 신뢰성 없음 (패킷 손실)
- ❌ 순서 보장 안 됨
- ❌ 흐름 제어 없음
- ❌ 혼잡 제어 없음

### 사용 예시
```
실시간 스트리밍:
- 음성/영상 통화
- 라이브 방송
- 일부 손실 허용

DNS 조회:
- 빠른 응답 필요
- 실패 시 재요청

게임:
- FPS (실시간 위치 동기화)
- 레이싱 게임
- 실시간 액션 게임
- 최신 상태만 중요
```

---

## [3] TCP vs UDP 비교

### 비교표
```
┌─────────────────┬──────────────────┬──────────────────┐
│     특성        │       TCP        │       UDP        │
├─────────────────┼──────────────────┼──────────────────┤
│ 연결            │ 연결 지향        │ 비연결           │
│ 신뢰성          │ 보장             │ 보장 안 함       │
│ 순서            │ 보장             │ 보장 안 함       │
│ 속도            │ 느림             │ 빠름             │
│ 헤더 크기       │ 20+ bytes        │ 8 bytes          │
│ 오버헤드        │ 큼               │ 작음             │
│ 흐름 제어       │ 있음             │ 없음             │
│ 혼잡 제어       │ 있음             │ 없음             │
│ 브로드캐스트    │ 불가능           │ 가능             │
│ 연결 타입       │ 1:1              │ 1:1, 1:N, N:N    │
└─────────────────┴──────────────────┴──────────────────┘
```

### 성능 비교
```
대역폭: 1 Mbps, 지연: 50ms

TCP:
- 연결 수립: ~150ms (3-way handshake)
- 데이터 전송: 1000ms
- 연결 종료: ~200ms (4-way handshake)
- 총 시간: ~1350ms

UDP:
- 데이터 전송: 1000ms
- 총 시간: ~1000ms

차이: 약 35% 빠름
```

### 데이터 크기별 비교
```
작은 데이터 (< 100 bytes):
TCP: 헤더 20+ bytes → 오버헤드 큼
UDP: 헤더 8 bytes → 효율적

큰 데이터 (> 10 KB):
TCP: 신뢰성 보장 → 안정적
UDP: 분할 전송 → 손실 위험
```

---

## [4] 게임에서의 TCP vs UDP

### MMORPG (World of Warcraft 스타일)

**TCP 사용:**
```
로그인/인증:
- 계정 정보 (반드시 전달)
- 캐릭터 데이터
- 인벤토리

채팅:
- 메시지 손실 안 됨
- 순서 보장

거래:
- 아이템 교환
- 골드 거래
- 100% 신뢰성 필요
```

**UDP 사용 (또는 TCP):**
```
이동:
- 플레이어 위치
- NPC 위치
- 실시간성 중요하지만
- MMORPG는 보통 TCP 사용
  (신뢰성 우선)
```

### FPS (Counter-Strike 스타일)

**UDP 사용:**
```
플레이어 위치:
- 초당 20-60번 업데이트
- 최신 위치만 중요
- 이전 위치는 버림

총알 발사:
- 실시간 전송
- 약간의 손실 허용

애니메이션:
- 캐릭터 동작
- 실시간성 중요
```

**TCP 사용:**
```
킬/데스 통계:
- 정확한 기록 필요

채팅:
- 메시지 손실 안 됨

서버 명령:
- 게임 시작/종료
- 룸 생성
```

### 하이브리드 방식 (많은 현대 게임)
```
게임 서버 구조:

TCP 연결:
┌────────────────────┐
│ Login Server       │
│ - 인증             │
│ - 캐릭터 정보      │
│ - 채팅             │
└────────────────────┘

UDP 연결:
┌────────────────────┐
│ Game Server        │
│ - 플레이어 위치    │
│ - 전투 액션        │
│ - 실시간 이벤트    │
└────────────────────┘

장점:
- TCP의 신뢰성 + UDP의 속도
- 용도에 맞는 프로토콜 사용
```

### League of Legends 예시
```
TCP 사용:
- 챔피언 선택
- 게임 결과
- 채팅
- 친구 시스템

UDP 사용:
- 챔피언 이동
- 스킬 사용
- 미니언 위치
- 실시간 전투
```

---

## [5] 선택 기준

### TCP를 선택해야 하는 경우
```
✅ 데이터 무결성이 중요
   - 파일 전송
   - 데이터베이스 동기화
   - 금융 거래

✅ 순서가 중요
   - 채팅 메시지
   - 명령 실행
   - 프로토콜 handshake

✅ 연결 상태 관리 필요
   - 세션 기반 서비스
   - 로그인 유지

✅ 신뢰성 > 속도
   - 웹 서비스
   - 이메일
   - 중요한 게임 로직
```

### UDP를 선택해야 하는 경우
```
✅ 실시간성이 중요
   - 음성/영상 통화
   - 실시간 게임
   - 라이브 스트리밍

✅ 약간의 손실 허용
   - 센서 데이터
   - 로그 전송
   - 모니터링

✅ 브로드캐스트 필요
   - 서버 탐색
   - LAN 게임
   - 멀티캐스트

✅ 속도 > 신뢰성
   - FPS 게임
   - 레이싱 게임
   - IoT 센서
```

### 하이브리드 (TCP + UDP)
```
✅ 복잡한 게임
   - MOBA (League of Legends)
   - MMORPG (일부)
   - 배틀로얄

✅ 실시간 + 신뢰성 둘 다 필요
   - 실시간 협업 툴
   - 화상 회의 (음성 UDP, 채팅 TCP)

✅ 서로 다른 데이터 타입
   - 중요 데이터: TCP
   - 실시간 데이터: UDP
```

---

## [6] 게임별 프로토콜 선택 예시

### 턴제 게임
```
프로토콜: TCP
이유:
- 턴 순서 중요
- 모든 명령 전달 필수
- 실시간성 덜 중요

예시: 하스스톤, 문명
```

### MMORPG
```
프로토콜: 주로 TCP (일부 UDP)
이유:
- 채팅, 거래 신뢰성 중요
- 플레이어 많음 (수천 명)
- 상태 동기화 중요

예시: WoW, FF14
```

### FPS
```
프로토콜: 주로 UDP (일부 TCP)
이유:
- 실시간 위치 동기화
- 낮은 지연 필수
- 약간의 손실 허용

예시: CS:GO, Valorant
```

### 레이싱 게임
```
프로토콜: UDP
이유:
- 극도의 실시간성
- 차량 위치 빠른 업데이트
- 최신 위치만 중요

예시: Forza, Gran Turismo
```

### 배틀로얄
```
프로토콜: TCP + UDP (하이브리드)
TCP:
- 인벤토리 관리
- 아이템 획득
- 킬/데스 기록

UDP:
- 플레이어 이동
- 총격전
- 실시간 전투

예시: PUBG, Fortnite
```

---

## [7] UDP 위에 신뢰성 구현 (RUDP)

### 문제
```
UDP는 빠르지만 신뢰성 없음
→ 중요한 패킷은 보장해야 함
```

### 해결: Reliable UDP
```
UDP + 직접 구현:

1) Sequence Number 추가
   - 패킷 순서 번호

2) ACK (확인 응답)
   - 수신 확인

3) 재전송
   - 타임아웃 시 재전송

4) 선택적 신뢰성
   - 중요 패킷만 ACK
   - 나머지는 UDP 그대로

패킷 구조:
┌────────────────────────┐
│ Sequence Number (4)    │
├────────────────────────┤
│ Flags (1)              │
│ - Reliable Flag        │
├────────────────────────┤
│ Data (가변)            │
└────────────────────────┘
```

### 상용 라이브러리
```
ENet:
- UDP 기반 신뢰성 라이브러리
- 게임에 최적화
- 많은 게임 엔진 사용

RakNet:
- UDP 기반
- P2P 지원
- 음성 채팅 지원

Photon:
- Unity 통합
- UDP 기반
- 클라우드 서버
```

---

## [8] 핵심 정리

### TCP
```
특징:
- 연결 지향
- 신뢰성 보장
- 순서 보장
- 느림

사용:
- 웹, 이메일, 파일 전송
- 게임: 로그인, 채팅, 거래
```

### UDP
```
특징:
- 비연결
- 신뢰성 없음
- 빠름

사용:
- 스트리밍, DNS
- 게임: 실시간 액션, 위치 동기화
```

### 선택 기준
```
신뢰성 중요 → TCP
속도 중요 → UDP
둘 다 → 하이브리드
```

### 게임 권장
```
턴제: TCP
MMORPG: TCP (또는 하이브리드)
FPS: UDP (또는 하이브리드)
레이싱: UDP
```